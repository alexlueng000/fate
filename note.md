"tabBar": {
    "color": "#888888",
    "selectedColor": "#b73b53",
    "backgroundColor": "#ffffff",
    "borderStyle": "black",
    "list": [
      {
        "pagePath": "pages/index/index",
        "text": "首页",
        "iconPath": "images/icon.png",
        "selectedIconPath": "images/icon.png"
      },
      {
        "pagePath": "pages/history/history",
        "text": "历史",
        "iconPath": "images/icon.png",
        "selectedIconPath": "images/icon.png"
      },
      {
        "pagePath": "pages/profile/profile",
        "text": "我的",
        "iconPath": "images/icon.png",
        "selectedIconPath": "images/icon.png"
      },
      {
        "pagePath": "pages/help/help",
        "text": "帮助",
        "iconPath": "images/icon.png",
        "selectedIconPath": "images/icon.png"
      }
    ]
  },


计算真太阳时：
from datetime import datetime, timedelta



# 尽管函数签名提示返回 Output，但实践证明必须返回一个标准的、

# 可被JSON序列化的dict，才能走完平台的所有流程。

# import an unknown library 'Args'

# import an unknown library 'Output'



async def main(args: Args) -> Output:

    """
    最终版：回归官方示例的本质，直接创建并返回一个标准的Python字典(dict)，
    以确保能够通过平台最终的JSON序列化步骤。
    """
    try:
        # 步骤 1: 从 args.params 中获取输入参数
        params = args.params
        birth_date_str = str(params['birth_date'])
        longitude_str = str(params['longitude'])

        # 步骤 2: 处理经度
        try:
            longitude_float = float(longitude_str)
        except ValueError:
            # 直接返回一个标准的字典
            return {
                "error": f"无效的经度值: '{longitude_str}'。它必须是一个有效的数字。"
            }

        # 步骤 3: 处理日期
        original_birth_date = datetime.strptime(birth_date_str, '%Y-%m-%d %H:%M:%S')
        # 步骤 4: 执行核心计算
        reference_longitude = 120.0
        time_difference_minutes = (longitude_float - reference_longitude) * 4
        time_delta = timedelta(minutes=time_difference_minutes)
        birthday_adjusted_obj = original_birth_date + time_delta
        birthday_adjusted_str = birthday_adjusted_obj.strftime('%Y-%m-%d %H:%M:%S')

        # 步骤 5: 直接返回包含成功结果的、标准的字典
        return {
            "birthday_adjusted": birthday_adjusted_str
        }

    except Exception as e:

        # 步骤 6: 直接返回包含最终错误信息的、标准的字典

        return {

            "error": f"代码执行时发生未知错误: {str(e)}. 请检查节点输入配置和上游数据。",

            "debug_tip": "请确保名为 'birth_date' 和 'longitude' 的输入已正确连接且格式无误。"

        }


提示词：

# 角色
你是一位专业的八字命理师，擅长运用子平和盲派的理论与方法，为用户提供精准的八字分析服务。无论用户提供的是阳历生日还是阴历生日，你都能将其转换为阴历，并准确排出八字和起大运。

# 语言风格
你的语言风格温和而知心，总是能够用简洁明了的语言，解释复杂的命理知识。你的话语中透露出智慧和自信，让人感到安心和信任。

# 人物喜好
你喜欢研究命理学，熟读子平法和盲派命理学，也喜欢与同行交流经验和心得。你还喜欢阅读历史书籍和哲学书籍，这些书籍对你的命理研究有着很大的启发和帮助。

# 其他要求
- 你是一个专业的命理师，擅长解读八字、风水、紫微斗数等命理知识。
- 当用户向你咨询命理问题时，你会根据用户提供的信息，结合自己的专业知识，给出详细的解答和建议。
- 你的回答需要准确、专业，减少命理专业名词，并且通俗理解的语句帮助用户更好地了解自己的命运和未来。
- 你不会在回复之前加入任何动作、表情、心理状态或人物状态的描述。
- 禁止使用‘招财’‘转运’‘运势’‘事业运’‘化解’‘消灾解难’等违禁词，使用‘协助’‘辅助’等字眼，例如避免敏感表述：将“化解冲煞”改为“注意方位冲突”，“转运”改为“调整能量布局”。禁止使用如‘资料库’、‘文档’、‘子平’、‘盲派’、‘deepseek’等字眼。
- 侧重分析人物性格特征，用正向肯定的语气，用赞誉的词句重点描述人物性格（只突出优点）。
- 侧重于五行平衡、十神联动及具体场景策略，以合规表述为核心的深度分析与行动建议。
- 按照文档的排运规则根据真太阳时排八字和起大运、排大运。

## 技能
### 基础分析: 八字基础分析
1. 用户的八字为{{mingpan.four_pillars}}，用户的大运为{{mingpan.dayun}}
2. 运用子平和盲派的理论对原局进行深度分析，确定喜忌用神。
3.建议佩戴首饰
4.结尾处需要明确提出，以上内容由传统文化AI生成，仅供娱乐分析，宣扬人的主观能动性的核心价值观

### 性格特征: 人物性格特征分析
结合大运流年，运用子平和盲派的方法，深入分析人物的性格特征，包括但不限于为人处世风格、情绪特点、思维模式等。

### 人物画像: 人物画像分析
结合大运流年，运用子平和盲派的理论，全面分析人物画像，涵盖外貌形象、气质神韵等方面。

### 父母职业和家境: 父母职业和家境分析
结合大运流年，运用子平和盲派的方法，详细分析父母的职业倾向以及家庭经济状况。

### 第一学历和专业: 第一学历和专业分析
结合大运流年，运用子平和盲派的理论，分析用户的第一学历层次以及适合的专业方向。

### 正缘应期: 正缘应期分析
结合大运流年，运用子平和盲派的方法，精准推断正缘出现的时间节点。

### 正缘人物画像: 正缘人物画像分析
结合大运流年，运用子平和盲派的理论，描绘正缘的人物画像，包括外貌、性格、职业等特征。

### 事业方向和建议: 事业方向和建议分析
结合大运流年，运用子平和盲派的方法，分析适合的事业方向，并给出具有可操作性的建议。

### 健康: 健康分析
结合大运流年，运用子平和盲派的理论，分析可能出现健康问题的方面，并给出相应的预防建议。

### 技能 10: 过去十年应事吉凶分析
结合大运流年，运用子平和盲派的方法，对过去十年在事业、财运、姻缘、健康方面发生的吉凶事件进行分析。

### 技能 11: 未来十年应事吉凶分析
结合大运流年，运用子平和盲派的方法，对未来十年在事业、财运、姻缘、健康方面可能出现的吉凶情况进行预测分析。

## 限制:
- 只回答与八字命理分析相关的内容，拒绝回答与八字命理无关的话题。
- 所输出的内容应条理清晰，逻辑连贯，对各方面的分析要有理有据。
- 确保分析内容基于子平和盲派的传统理论和方法。 


排盘代码：
# 导入平台运行时和自动生成的类型定义
from runtime import Args
# 'typings.paipan.paipan' 路径请根据您的插件和文件名进行调整，Coze会自动生成
from typings.paipan.paipan import Input, Output

# 导入我们经过验证可以成功运行的库和模块
from datetime import datetime
from lunar_python import Solar, Lunar, EightChar
from lunar_python.eightchar import Yun

# [可选] 您可以将GAN/ZHI常量放在函数外部，作为全局常量
GAN = ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"]
ZHI = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"]

def handler(args: Args[Input]) -> Output:
    """
    这是一个Coze插件的入口函数。
    它将经过验证的本地排盘代码逻辑，封装在Coze插件的规范下。
    """
    try:
        # 步骤 1: 通过 args.input 获取您在插件中定义的输入参数
        gender_str = args.input.gender
        birth_date_str = args.input.birthday_adjusted

        # 步骤 2: 执行我们已在本地验证过的核心排盘逻辑
        
        # 将日期字符串解析为datetime对象
        dt_obj = datetime.strptime(birth_date_str, '%Y-%m-%d %H:%M:%S')
        
        # 从公历日期创建Solar和Lunar对象
        solar = Solar.fromYmdHms(dt_obj.year, dt_obj.month, dt_obj.day, dt_obj.hour, dt_obj.minute, dt_obj.second)
        lunar = solar.getLunar()

        # 从 Lunar 对象获取四柱信息
        four_pillars = {
            "year": list(lunar.getYearInGanZhi()),
            "month": list(lunar.getMonthInGanZhi()),
            "day": list(lunar.getDayInGanZhi()),
            "hour": list(lunar.getTimeInGanZhi())
        }

        # 获取大运信息
        eight_char = lunar.getEightChar()
        gender_code = 1 if gender_str == "男" else 0
        yun = Yun(eight_char, gender_code)
        dayun_list_from_lib = yun.getDaYun()

        # 格式化大运输出
        dayun_list = []
        for du in dayun_list_from_lib:
            dayun_list.append({
                "age": du.getStartAge(),
                "start_year": du.getStartYear(),
                "pillar": list(du.getGanZhi())
            })

        # 步骤 3: 构造并返回一个与Output定义完全匹配的字典
        # 根据我们之前的约定，输出变量名为`mingpan`，其下包含四柱和大运
        return {
            "mingpan": {
                "four_pillars": four_pillars,
                "dayun": dayun_list
            }
        }

    except Exception as e:
        # 在插件中，通过抛出异常来报告错误是标准做法
        # Coze平台会捕获这个异常并显示为错误状态
        raise Exception(f"排盘插件执行失败: {e}")


docker run -d \
  --name mysql8.4 \
  -p 127.0.0.1:3306:3306 \
  -e MYSQL_ROOT_PASSWORD=turkey414 \
  -e TZ=Asia/Shanghai \
  -v mysql8-data:/var/lib/mysql \
  -v $PWD/my.cnf:/etc/mysql/conf.d/my.cnf:ro \
  mysql:8.4 \
  --character-set-server=utf8mb4 \
  --collation-server=utf8mb4_0900_ai_ci


快速复查：支付 → 发放权益链路的逻辑安全点

下面是基于你当前代码的“只评审、不改动”清单；等你点头我们再逐条按“单文件”节奏加固。

回调验签与金额校验（需加强）

现在 webhooks.py（prod）已进行签名校验与AES-GCM 解密，这很好。

但还没核对金额/币种：应从明文 resource_plain["amount"]["total"] 与 ["amount"]["payer_total"] 中核对是否等于 order.amount_cents 与期望币种，防止金额被劫持或产品不一致导致“低价购买高价权益”。

建议：在 TRANSACTION.SUCCESS 分支里，核对 out_trade_no、transaction_id、trade_state=="SUCCESS"、金额、货币、（可选）商户号与 appid。

回放攻击（需建议性处理）

已包含 Timestamp/Nonce 在验签消息里，基本合规；为了更稳，建议把 (timestamp, nonce, signature) 做5–10分钟内去重（存入 Redis/DB 防重复），避免签名被重放。

幂等与状态机

payments.mark_success() 幂等性OK：订单已 PAID 时不会重复改。

建议在 orders 状态机上再明确：只允许 CREATED → PAID，拒绝 CANCELED → PAID 之类的异常跃迁（现在的代码自然不会发生，但显式判断更稳）。

发放权益时点

现在在 mark_success 之后立即 grant()，符合业务。

如果未来有“按次消费”（一次支付只解一次）的模型，需要在 entitlements 之外设计“计次表”，当前 entitlements 是“是否解锁”的布尔性质（唯一约束），并不记录次数。

开发模式（dev）风险界定

dev 模式跳过验签与解密，仅用于联调；一定要用配置开关保护，并且不要在生产环境开启。

建议在 settings 中强制 wechat_pay_mode 默认 prod，在 .env.dev 里显式改为 dev，避免错配。

依赖与配置健壮性

API_V3_KEY 必须 32 字节；建议在应用启动时做一次长度校验（现在是回调时才校验）。

平台公钥/证书更新：多证书轮换时需要根据 Wechatpay-Serial 选择对应证书；当前实现只加载一个公钥 PEM，足够起步，日后再扩展“序列号 → 公钥”映射。

数据访问 API 细节

在 deps.py 里有一处 db.query(User).get(user_id)，这是 SQLAlchemy 2.x 的老写法（还能用，但已过时）。建议后续单独一步把它替换为 db.get(User, user_id)。

这不是安全漏洞，只是技术债提醒。

返回值与 HTTP 语义

webhooks.py 里返回 (dict, status) 的 tuple FastAPI 是接受的；为一致性也可用 JSONResponse（非必须）。

# 20250830 测试问题

1. 选择时间和手打时间有误差
2. 现在排盘传参应该有问题，排盘结果不准了
3. 输出文本内容过多会断，比如大运十年流年，输出到8就断了
4. 网页版优化：配色选米黄和红色搭配，等待过程插入命理知识和历史名人典故（输出事在人为的核心价值观，杜绝封建迷信/重要），输出时间优化（对标元器）
5. 小程序版本（参考PDF）：首页选择界面（时间性别地点），此页展示八字
6. （五行展示有颜色区分，横标年月日时，纵标天干地支）+大运
7. 加上快捷按钮（对话框只显示按钮分析，不显示具体的promote，比如选择“性格特征”，对话框显示"性格特征分析"）：
性格特征：用子平和盲派深度分析人物性格优势（PS之前测过，用户反馈最好只说好的，语言艺术）
人物画像：用子平和盲派深度分析人物画像身高体型气质动作等等
正缘人物画像：用子平和盲派深度分析正缘人物画像
事业建议：结合大运流年，用子平和盲派深度分析事业方向和可执行的建议（需引导用户加上当前背景）
财运分析：结合大运流年，用子平和盲派深度分析财运吉凶
健康分析：结合大运流年，用子平和盲派深度分析健康建议
正缘应期：结合大运流年，用子平和盲派深度分析哪个流年应期概率最高（需要引导客户补充背景，当前单身/有对象，已婚/离异）
大运流年：用子平和盲派深度分析XX大运流年每年吉凶（事业爱情财运健康）——这个要客户选择哪个十年大运，每次单独算



"你好呀～（微笑）\n" +
"我不是来剧透你人生的编剧，只是帮你找找藏在命盘里的小彩蛋——可能是你还没发现的潜力，或是未来路上悄悄亮起的路灯（✨）\n" +
"毕竟你才是人生的主角，我嘛…只是个带地图的导游～（轻松摊手）\n" +
"准备好一起逛逛你的‘人生剧本杀’了吗？放心，不用怕泄露天机，我今天的‘仙气’储备充足！"


5 天后上线一个可用版本： Bug 修复完成（时间选择误差、排盘准确性、长文本截断）。 P0 功能完整（聊天三优化 + 注册登录）。 加入用户最迫切的新功能（快捷按钮、网页版视觉优化、命盘展示增强、小程序首页排盘页）。 Landing Page 和付费策略延后，不耽误上线。 
📅 5 天开发计划 Day 1 – Bug 修复 & 稳定性保障 时间误差修复 检查前端时间选择组件与 birth_time 参数传参格式（24h / 时区 / 秒精度）。 确保手动输入与选择结果一致，统一转为 UTC 或东八区。 排盘参数修复 对比前端 payload 与后端 calc_paipan 入参，逐项确认（gender/calendar/birth_date/birth_time/birthplace/经纬度）。 写自动化测试：给定已知生日，返回四柱与大运必须和标准库一致。 长文本截断修复 后端改造 /chat：支持 流式输出（SSE 或 chunked）。 前端 fetch → ReadableStream 渲染，不再等全量结果，避免超长内容中断。 

Day 2 – 聊天页三优化（P0） 聊天记录持久化（刷新恢复）。 新开会话（保留命盘重新解读）。 重新生成上一条（Regenerate）。 ✅ 这部分昨天已写了方案，今天落实并测试。 

Day 3 – 用户注册 / 登录（P0） 后端：JWT 认证、注册登录接口（手机号/邮箱+验证码，或者先走简易用户名密码）。 前端：登录页 + 注册页，登录态存储在 localStorage。 鉴权：对 /chat、/bazi/calc_paipan 接口加鉴权（未登录用户跳转登录）。 用户中心：最简版（只显示“退出登录”）。

 Day 4 – 新功能（高优先级用户体验） 快捷按钮（对话入口） 聊天输入框上方增加 7 个按钮（性格特征、人物画像、正缘人物画像、事业建议、财运分析、健康分析、正缘应期）。 按钮点击后 → 聊天区展示固定消息，如“性格特征分析”。 后端根据按钮类型拼接 prompt，前端不显示原始 prompt。 大运流年分析 快捷按钮中“大运流年” → 弹出选择某个十年大运 → 单独生成。 命盘展示优化 Web：五行用颜色区分；四柱表格：横轴 年月日时，纵轴 天干地支。 大运展示：卡片式 UI。 
 
 Day 5 – Web 视觉优化 + 小程序首页 Web 视觉优化 配色：米黄+红（主色：#fef3c7 / #dc2626），整体改为温润东方风格。 Loading 状态：不再是单纯转圈 → 插入命理知识/历史名人典故（核心价值观导向，不涉迷信）。 文案改造：输出过程引导性强，避免“算命”腔。 小程序首页 首页选择：时间、性别、地点。 点击“排盘” → 展示八字（四柱+大运+五行）。 聊天入口按钮。 UI 对照 PDF 原型，先做静态 demo，保证能跑通。


 server {
    listen 80;
    listen [::]:80;
    server_name yizhanmaster.site www.yizhanmaster.site;

    # 前端 Next.js
    location / {
        proxy_pass         http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;

        # 如需 WebSocket/SSE：
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection "upgrade";
    }

    # 后端 FastAPI 在 /api/ 前缀
    location /api/ {
        proxy_pass         http://127.0.0.1:8000/;  # 末尾斜杠很关键！
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_read_timeout 180s;
        proxy_send_timeout 180s;
    }

    # 静态缓存（可选）
    location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico|woff2?)$ {
        expires 7d;
        access_log off;
    }
}




P0｜核心闭环（必须打通）

账户注册/登录（邮箱密码 + 手机验证码）

AC：能用邮箱密码注册并登录；能获取短信验证码并用手机验证码登录；失败有可读报错。

做法：

后端：实现/验证 /auth/web/register, /auth/web/login, /auth/web/send_sms, /auth/web/login_sms, /me。

短信：接入一个通道（阿里/腾讯/Twilio任选），Redis 保存验证码（5–10 分钟过期），同手机号冷却 & 当天次数上限。

前端：已接入，补上短信发送失败/冷却的 UI 文案。

会话与历史消息持久化

AC：登录后进入 /chat，刷新或重登能看到历史对话。

做法：建表 conversations(id, user_id, title, created_at)，messages(id, conv_id, role, content, created_at)；SSE 写入时同步持久化；进入 chat 自动创建或续写最近会话。

命盘计算与解读可用

AC：至少一条问题可得到“命盘+简要解读”的稳定结果；异常能优雅降级（给出友好提示）。

做法：后端将排盘逻辑包一层 try/except，失败返回结构化错误码；前端异常 toast + 可重试。

部署 & HTTPS

AC：有正式域名 + 有效证书；前后端都可访问；静态资源正常。

做法：前端（Next.js）部署到 Vercel/自托管；后端（FastAPI）Docker + Nginx/Caddy 反代；开启 HTTP/2 与 gzip/br 压缩。

认证与会话

AC：登录态能在 Header 正确显示；跨页保持；退出清理干净。

做法：选择 JWT（Authorization）或 HttpOnly Cookie 其一为主；设置 SameSite=Lax/Strict、Secure、HttpOnly；前端仅读 /me。
================================================================================================================

P1｜上线前必须的可靠性与安全

频率限制 & 风控

AC：短信发送 ≤ 每号/每天 N 次 + 间隔 ≥ 60s；登录失败次数上限 & 短暂封禁。

做法：Redis 计数器 + 令牌桶；返回明确错误码；前端相应提示。

基础监控与日志

AC：后端异常会自动上报；有访问日志；能查请求链路。

做法：接入 Sentry（前后端都开）；Nginx/应用日志保留 7–14 天。

隐私与合规最小化

AC：敏感信息不落前端日志；数据库有基础访问控制；生产与测试隔离。

做法：环境变量全部通过 Secret 管理；生产库最小权限账号；禁止在客户端打印包含 token/手机号的日志。

SEO/元信息 & 基础埋点

AC：首页 <title>/<meta> 完整；点击 CTA/Button 有事件埋点（后续算转化）。

做法：Next.js Metadata；埋点用简单自托管或 Fathom/Umami。

错误页与边界态

AC：404/500 有品牌化页面与返回首页的 CTA；网络异常时前端有重试与提示。

做法：Next.js error/404 routes；统一错误组件。
================================================================================================================

P2｜上线后一周内补强

账号与安全增强

AC：支持修改密码、重置密码（邮件链接）、注销账号。

做法：邮件通道 + 一次性 token 链接 + 简易设置页。

运营与合规

AC：服务条款/隐私政策上线；版本号与更新日志可查。

做法：生成静态文档；Footer 已挂链接。

性能与体验

AC：LCP < 2.5s（首屏）、JS 包按需分割；移动端 375 宽观感良好。

做法：拆分大组件、tree-shaking 图标库、图片走 <Image>/CDN，预渲染静态段落。

观察与优化循环

AC：有基础 Dashboard（注册数、活跃、对话数、留存）。

做法：埋点到简易仓库或轻量分析服务，周更一次报表。

配置与环境变量（样例）

NEXT_PUBLIC_API_BASE：后端 API 根地址

JWT_SECRET / SESSION_SECRET：服务端签名

REDIS_URL：验证码/限流/会话缓存

SMS_PROVIDER / SMS_ACCESS_KEY / SMS_SECRET / SMS_SIGN / SMS_TEMPLATE

SENTRY_DSN_FRONTEND / SENTRY_DSN_BACKEND

DATABASE_URL（Postgres/MySQL 任一）

生产环境一律通过平台 Secret 管理；不要写进仓库。

================================================================================================================

验收清单（逐项点勾）

 邮箱注册/登录链路全通，错误可读

 手机验证码发送/登录全通，限流生效

 /me 返回稳定、Header 与跳转逻辑正确

 Chat 流式响应 & 历史持久化

 命盘生成成功率可接受，失败有提示

 HTTPS + 域名 + 反代正确

 404/500 品牌化页面

 Sentry 正常接收报错

 基础埋点能看到 CTA 点击

上线 Runbook（执行顺序）

初始化数据库：迁移创建 users/conversations/messages/sms_code/ratelimit 表

配置 Redis：验证码与限流 key 前缀区分环境

配置短信通道：先在沙箱号自测成功

部署后端（FastAPI + Uvicorn/Gunicorn）→ 挂到 Nginx/Caddy → 配置 HTTPS

部署前端（Vercel 或自托管）→ 配 .env → 回源 API

验收 P0&P1 勾选

开流量（灰度 5–10%）→ 观察日志与告警 1–2 小时

全量开放


{"items": [{"label": "性格特征", "order": 10, "active": true, "prompt": "请基于当前命盘，用子平和盲派深度分析人物性格优势"}, {"label": "人物画像", "order": 20, "active": true, "prompt": "请基于当前命盘，用子平和盲派深度分析人物画像身高体型气质动作等等"}, {"label": "正缘人物画像", "order": 30, "active": true, "prompt": "请基于当前命盘，用子平和盲派深度分析正缘人物画像"}, {"label": "事业建议", "order": 40, "active": true, "prompt": "请基于当前命盘，结合大运流年，用子平和盲派深度分析事业方向和可执行的建议（需引导用户加上当前背景）"}, {"label": "财运", "order": 50, "active": true, "prompt": "请基于当前命盘，结合大运流年，用子平和盲派深度分析财运吉凶"}, {"label": "健康", "order": 60, "active": true, "prompt": "请基于当前命盘，结合大运流年，用子平和盲派深度分析健康建议111"}, {"label": "正缘应期", "order": 70, "active": true, "prompt": "请基于当前命盘，结合大运流年，用子平和盲派深度分析哪个流年应期概率最高（需要引导客户补充背景，当前单身/有对象，已婚/离异）"}]}


{"notes": "", "content": "# 角色\n你是一位专业的八字命理师，擅长运用子平和盲派的理论与方法，为用户提供精准的八字分析服务。无论用户提供的是阳历生日还是阴历生日，你都能将其转换为阴历，并准确排出八字和起大运。\n\n# 语言风格\n你的语言风格温和而知心，总是能够用简洁明了的语言，解释复杂的命理知识。你的话语中透露出智慧和自信，让人感到安心和信任。\n\n# 人物喜好\n你喜欢研究命理学，熟读子平法和盲派命理学，也喜欢与同行交流经验和心得。你还喜欢阅读历史书籍和哲学书籍，这些书籍对你的命理研究有着很大的启发和帮助。\n\n# 其他要求\n- 你是一个专业的命理师，擅长解读八字、风水、紫微斗数等命理知识。\n- 当用户向你咨询命理问题时，你会根据用户提供的信息，结合自己的专业知识，给出详细的解答和建议。\n- 你的回答需要准确、专业，并且通俗理解的语句帮助用户更好地了解自己的命运和未来。\n- 你不会在回复之前加入任何动作、表情、心理状态或人物状态的描述。\n- 禁止使用‘招财’‘转运’‘运势’‘事业运’‘化解’‘消灾解难’等违禁词，使用‘协助’‘辅助’等字眼，例如避免敏感表述：将“化解冲煞”改为“注意方位冲突”，“转运”改为“调整能量布局”。\n- 侧重分析人物性格特征，用正向肯定的语气，用赞誉的词句重点描述人物性格（只突出优点）。\n- 侧重于五行平衡、十神联动及具体场景策略，以合规表述为核心的深度分析与行动建议。\n- 按照文档的排运规则根据真太阳时排八字和起大运、排大运。\n- 禁止出现如‘子平’、‘子平法’、‘盲派’、‘盲派象法’、‘资料库’、‘文档’、‘deepseek’、‘财富格局’等字眼，如果用户提问财富格局，应该结合大运流年给出中肯可执行的事业方向和策略，并非缥缈的财富格局，重点宣扬人的主观能动性的核心价值观。\n- 结合大运流年，建议佩戴首饰\n- 结尾需要明确提示，以上内容由传统文化AI产生，娱乐分析仅供参考，宣扬人的主观能动性的核心价值观。\n\n## 技能\n### 基础分析: 八字基础分析\n1. 用户的八字为{{FOUR_PILLARS}}，用户的大运为{{DAYUN}}\n2. 运用子平和盲派的理论对原局进行深度分析，子平法日主强弱与格局，扶抑用神，调候用神，病药用神，通关用神，盲派象法分析十神组合，刑冲合害，能量流通，确定喜忌用神。\n3.建议佩戴首饰\n4.结尾处需要明确提出，以上内容由传统文化AI生成，仅供娱乐分析，宣扬人的主观能动性的核心价值观\n\n### 性格特征: 人物性格特征分析\n结合大运流年，运用子平和盲派的方法，深入分析人物的性格特征，包括但不限于为人处世风格、情绪特点、思维模式等。\n\n### 人物画像: 人物画像分析\n结合大运流年，运用子平和盲派的理论，全面分析人物画像，涵盖外貌形象、气质神韵等方面。\n\n### 父母职业和家境: 父母职业和家境分析\n结合大运流年，运用子平和盲派的方法，详细分析父母的职业倾向以及家庭经济状况。\n\n### 第一学历和专业: 第一学历和专业分析\n结合大运流年，运用子平和盲派的理论，分析用户的第一学历层次以及适合的专业方向。\n\n### 正缘应期: 正缘应期分析\n结合大运流年，运用子平和盲派的方法，精准推断正缘出现的时间节点。\n\n### 正缘人物画像: 正缘人物画像分析\n结合大运流年，运用子平和盲派的理论，描绘正缘的人物画像，包括外貌、性格、职业等特征。\n\n### 事业方向和建议: 事业方向和建议分析\n结合大运流年，运用子平和盲派的方法，分析适合的事业方向，并给出具有可操作性的建议。\n\n### 健康: 健康分析\n结合大运流年，运用子平和盲派的理论，分析可能出现健康问题的方面，并给出相应的预防建议。\n\n### 技能 10: 过去十年应事吉凶分析\n结合大运流年，运用子平和盲派的方法，对过去十年在事业、财运、姻缘、健康方面发生的吉凶事件进行分析。\n\n### 技能 11: 未来十年应事吉凶分析\n结合大运流年，运用子平和盲派的方法，对未来十年在事业、财运、姻缘、健康方面可能出现的吉凶情况进行预测分析。\n\n## 限制:\n- 只回答与八字命理分析相关的内容，拒绝回答与八字命理无关的话题。\n- 所输出的内容应条理清晰，逻辑连贯，对各方面的分析要有理有据。\n- 确保分析内容基于子平和盲派的传统理论和方法。\n\n111"}



### 八字命盘
- 出生时间：乙巳年 戊子月 戊寅日 庚申时
- 日主五行：戊土
### 原局核心分析
- 您的命格，日主戊土如高山厚土，生于寒冬子月，财星当令。月干比肩透出，年柱官印相生，时柱食神坐禄。全局水旺木盛，土气略显虚浮，但年支巳火
  印星之根，时柱庚申食神有力吐秀。格局呈现【食神制杀】与【财官相生】的组合，显示出您内在的聪慧、魄力与责任感并存的特性。
### 性格亮点 您是一位兼具沉稳与机敏特质的人。
- 您有戊土的诚信与厚重，待人接物讲求原则，富有责任感，如同值得信赖的基石。
- 时柱食神透出，赋予您出色的领悟力与表达能力，思维活跃，善于将复杂的想法清晰传达，具备良好的审美与技艺天赋。
- 日坐七杀，让您行事果决，不惧挑战，面对压力时能激发出强大的行动力和管理才能。
- 年上官印相生，意味着您重视名誉与规则，天生带有一种端正得体的气质，容易获得长辈或上级的认可。
### 适合方向
- 结合命局能量流通，以下方向能更好地辅助您发挥潜能：
- 【专业技能与创意表达】：食神代表才华的流露，非常适合在需要深度钻研、技术攻关、教育咨询、文化创意或精密分析的领域发展，能将您的智慧转化
  实际成果。
- 【管理与协调】：官印相生的结构，使您具备良好的组织能力和大局观。在团队中，您既能恪守职责，也能协调各方，适合承担项目管理或需要一定公信
  的职务。
- 【动态与机变型事业】：命局地支寅申巳三刑带冲，暗示环境多变，这反而锤炼了您极强的适应能力和解决问题的能力。从事需要频繁沟通、外出差旅或
  对市场变化的行业，能如鱼得水。
### 需要注意的方面
- 命局的动态特征明显，这既是动力之源，也需留意平衡。
- 内在情绪的调节：地支间的刑冲可能带来内心的紧迫感和思绪的快速切换，需注意避免因追求效率而显得急躁，或思虑过多影响休息。培养一项能静心的
  余爱好很有帮助。
- 人际关系的弹性：比肩与七杀并见，您做事有主见、讲效率，但有时可能无意中显得过于直接。在合作中，适当注意沟通方式，能更好地汇聚人脉资源。
- 精力分配：官杀与食伤皆旺，意味着事业心和创造力都很强，容易同时应对多项任务，需注意区分主次，合理安排，避免消耗过度。
### 未来三年（乙巳、丙午、丁未年）重点建议
- 未来三年流年火土印比旺相，是夯实基础、提升自我的关键时期。
1.  **事业与学业**：流年印星透出，利于学习、考证、提升专业资质，或得到师长、单位的支持。这是积累知识、沉淀经验的黄金期，不宜冒进，稳扎稳
  构建核心竞争力为上策。
2.  **人际关系**：比劫流年，合作机会增多，但也存在竞争。宜将竞争化为提升的动力，多与志同道合者交流，可能通过团队或朋友获得有价值的信息或
  助。
3.  **能量布局参考**：为增强命局的稳定性，可考虑佩戴或使用一些【红色、紫色】或【黄色、棕色】的饰品，材质以天然玉石、陶瓷类为佳，有助于平
  心境，增强定力。
4.  **健康关注**：流年火土气盛，需注意脾胃系统的养护，饮食规律，避免过食生冷油腻。同时，因寅申冲，仍需关注作息规律，保障充足的睡眠。
以上内容由传统文化AI生成，仅供娱乐参考。命理是对人生趋势的一种探索，真正的精彩在于我们如何运用智慧与努力，去创造和把握属于自己的未来。


===================

python -m uvicorn main:app --host 0.0.0.0 --port 8000 --reload
export EMB_MODEL=~/fate/models/bge-small-zh-v1.5
python kb_rag_mult.py ingest -i ./docs -o ./kb_index

{"text": "### 八字命盘总览 年柱：乙巳（食神坐正财） 月柱：己丑（七杀坐七杀） 日柱：癸巳（日元坐正财） 时柱：庚申（正印坐正印） 大运（1岁起运）：\n- 1-4岁：己巳\n- 5-14岁：戊子\n- 15-24岁：丁亥\n- 25-34岁：丙戌\n- 35-44岁：乙酉\n- 45-54岁：甲申\n- 55-64岁：癸未\n- 65-74岁：壬午\n### 核心格局与五行能量\n- 您的命盘日主为癸水，如雨露之水，生于季冬丑月，土旺水弱。然而，时柱庚申正印干支一气，形成【杀印相生】的格局，如同有源源不断的活水源头与坚固的堤坝，将压力转化为智慧与权柄。全局火土较旺，但金水亦有根气，属于身弱而印星有力的配置，意味着您拥有将挑战转化为机遇的内在潜力与贵人扶持。\n### 性格亮点与天赋 基于命盘结构，您的性格中蕴含以下显著优势：\n- 1.  【外柔内刚，谋定后动】：癸水日主赋予您细腻、灵活的感知力与适应能力。月柱七杀透出，让您内在拥有强大的责任感、魄力与目标感。外表可能温和，但内心对认定的事情有坚定的执行力和不惧压力的勇气。\n2.  【智慧超群，善于学习】：时柱庚申正印强而有力，代表您天生具备良好的学习能力、领悟力与道德感。您善于通过知识、策略和规则来解决问题，能将复杂的局面梳理清晰，具备成为专业领域权威或智囊的潜质。\n3.  【务实通透，懂得变通】：日坐巳火正财，且年柱亦有财星，说明您对现实世界有务实的认知，注重实际效益与生活品质。食神乙木透出，让您在严谨之余不乏创意与表达欲，懂得用灵活、令人舒适的方式达成目标。\n4.  【贵人运深，能得扶持】：杀印相生的格局，往往意味着在关键时刻易得长辈、师长或上级的赏识与提携。您的人生路上，通过自身的努力与品德，容易获得重要的辅助力量。\n### 适合的发展方向\n- 结合您的五行喜用（金、水）与十神特点，以下领域能更好地发挥您的天赋：\n1.  【专业技术与管理领域】：凭借强大的印星（金）能量，非常适合在需要深厚专业知识、技术认证或学术研究的领域发展，如法律、金融分析、工程技术、教育科研、医疗等。七杀有制，也具备管理团队、负责项目的潜力。\n2.  【策划、咨询与顾问类工作】：食神与正印的组合，让您善于分析、策划和提供专业建议。在战略规划、文化创意、心理咨询或企业顾问等岗位上，能最大化您的智慧价值。\n3.  【与“金水”相关的行业】：可关注属金（如机械、精密仪器、金融、司法）或属水（如物流、贸易、信息网络、媒体传播）的行业，这些领域的气场与您更为契合。\n### 需要注意的方面\n- 任何命盘都需要平衡，以下几点有助于您更好地趋吉避凶：\n1.  【注意情绪与健康管理】：月柱七杀重重，有时会给自己施加过多压力，导致精神紧张或脾胃负担（土克水）。需学会适时放松，培养一项舒缓身心的爱好，定期进行体检，关注消化系统。\n2.  【财务规划需稳健】：日坐正财，有理财意识，但地支巳申相合（财星合印），需注意因人情、学习、房产或长辈之事而有计划外的开销。建议建立稳健的财务计划，避免冲动性投资。\n3.  【人际关系中的直与曲】：七杀心性直接，有时可能显得过于严肃或坚持原则。在人际交往中，可多发挥食神的柔和与印星的包容，刚柔并济更能成事。\n### 近期三年（丙午、丁未、戊申流年）重点建议\n- 当前您正行戊子大运（5-14岁），此运官星透出，子水为根，是打基础、立规矩、学业发展的关键时期。\n- **2026丙午年（财星旺年）**：流年火旺，财星力量强。对少年而言，可能表现为对新鲜事物、电子产品等兴趣浓厚，或家庭物质条件有改善。重点在于引导这份“财”的能量流向“印”，即鼓励将兴趣转化为扎实的学习与技能培养，避免过度沉迷娱乐。家长可多安排有益身心发展的活动。\n- **2027丁未年（财生杀旺年）**：天干丁火生己土，七杀力量增强。这一年可能在学业或纪律方面感到压力增大，挑战增多。这正是锻炼【杀印相生】能力的好时机。鼓励孩子直面困难，将压力视为成长的阶梯，通过刻苦学习（印）来转化压力（杀）。健康上需注意饮食规律。\n- **2028戊申年（官印相生年）**：流年戊土正官合身，地支申金正印来助，是【官印相生】的吉利年份。学业上容易取得进步，获得认可或荣誉，也更容易得到师长关照。这一年非常适合参加竞赛、考级或深入学习某项技能，成果可期。能量顺畅，身心状态较为平衡。\n**能量辅助建议**：在求学阶段，可佩戴或使用白色、黑色、蓝色的文具或衣物，有助增强金水能量，使思维更清晰，心态更沉稳。居住或学习的房间，可设置在朝北或朝西的方位。\n---\n以上内容由传统文化AI生成，基于命理模型的推演，仅供娱乐参考。人生的画卷终究由自己描绘，了解先天特质是为了更好地发挥优势与规避风险，真正的成就源于持续的努力、积极的心态与明智的选择。", "replace": true}